angular.module("aimprApp",["ngAnimate","monospaced.elastic","ngRoute","truncate","ngStorage","cgNotify"]).config(["$locationProvider",function(r){return r.html5Mode({enabled:!0,requireBase:!1})}]),angular.module("aimprApp").controller("BestLyricsCtrl",["$scope","LyricsProcessor","ViewHelpers","TrackService",function(r,e,n,t){return r.helpers=n,console.info("BestLyricsCtrl"),r.cur_track=t.cur_track,null==r.cur_track.lyrics?(r.cur_track.is_loading=!0,e.improveOne(r.cur_track,function(e){return r.$emit("setSelectedSite"),Object.keys(e.lyrics).length||(e.state="failed"),r.$apply()})):void 0}]),angular.module("aimprApp").controller("FriendsCtrl",["$scope","$interval","API","Info",function(r,e,n,t){var i,o,u,a,c,s,l,d,f,p,_;console.info("FriendsCtrl"),u=0,l=7,i=1,d=15,o=1,r.getPerPage=function(){return i},r.search={name:""},r.is_loading=!1,s=!1,r.user_id=t.user_id,r.viewer_id=t.viewer_id,r.$watch(function(){return t.user_id},function(e){return r.user_id=e}),r.$watch(function(){return t.viewer_id},function(e){return r.viewer_id=e}),f=function(e){var n,t,o;return t=Math.ceil(u/l),"next"===e&&(t>i?i+=1:i=1),o=l*(i-1),n=o+l-1,r.rendered_friends=r.friends.slice(o,+n+1||9e9)},a=function(){var e;return e={count:d,offset:d*(o-1)},n.getFriends(788157,e).then(function(e){return u=u||e.count,r.friends=(r.friends||[]).concat(e.items),f("cur"),o+=1,r.$apply()})},a(),r.showPart=function(r){return f(r),c()&&!s?a():void 0},c=function(){var e;return e=Math.ceil(r.friends.length/l)-1,i===e},p=function(e){var n,t;return t=new RegExp(e,"gim"),n=function(r){return t.test(r.first_name)||t.test(r.last_name)},r.friends.filter(n).slice(0,10)},_="",r.getFriendsByName=function(t){var i,a;return _=t,r.is_loading?console.info("loading friends for searching.."):t.length>0?r.friends.length<u?(r.rendered_friends=p(t),r.is_loading=!0,r.friends=r.friends.slice(0,+(d-1)+1||9e9),i=Math.ceil(u/d)-1,o=2,a=e(function(){var t;return 0===i?(e.cancel(a),r.rendered_friends=p(_),r.is_loading=!1,void(s=!0)):(t={count:d,offset:d*(o-1)},n.getFriends(788157,t).then(function(e){return r.friends=r.friends.concat(e.items),o+=1,i-=1}))},333)):r.rendered_friends=p(t):f("cur")},r.showUserTracks=function(e){return r.$emit("showUserTracks",e)}}]),angular.module("aimprApp").controller("InfoCtrl",["$scope","Stat","API","Info","Ladda",function(r,e,n,t,i){var o;return console.info("InfoCtrl"),r.stat=e,o=function(){return r.$emit("improveList"),i.start()},r.improveList=function(){return t.viewer_id===t.user_id?o():r.$emit("showUserTracks",t.viewer_id,function(){return o()})},n.getAudioCountAndLyricsIds(t.viewer_id).then(function(e){return r.stat.all_count.all=e.audio_count,r.stat.without_lyrics_count.all=e.without_lyrics.filter(function(r){return!r}).length,t.without_lyrics_count=r.stat.without_lyrics_count.all})}]),angular.module("aimprApp").controller("PlayerCtrl",["$scope","$rootScope","$interval","audio",function(r,e,n,t){var i,o,u,a,c,s,l;return console.info("PlayerCtrl"),r.cur_time=0,r.cur_playing=null,r.position={cur:0,max:1e3},c=null,t.setEndHandler(function(){return r.$emit("getNextTrack",r.cur_playing.id)}),l=function(e,n){return"time_to_position"===n?r.cur_time*r.position.max/r.cur_playing.duration:r.cur_playing.duration*r.position.cur/r.position.max},a=function(){return n.cancel(c),c=null},s=function(){return t.el.currentTime<r.cur_playing.duration&&(r.cur_time=t.el.currentTime),r.position.cur=l(r.cur_time,"time_to_position")},r.$watch("position.cur",function(e){return r.cur_playing?(t.el.currentTime=l(e,"position_to_time"),s()):void 0}),o=function(e){return e.id!==r.cur_playing.id&&(u(e),r.position.cur=0,r.cur_time=0,a()),c||(c=n(function(){return s()},1e3)),0===r.cur_time?t.play(e.url):t.play(),s()},i=function(){return a(),t.pause()},r.playOrPause=function(){return r.cur_playing.is_playing=!r.cur_playing.is_playing,r.cur_playing.is_playing?o(r.cur_playing):i(r.cur_playing)},e.$on("setFirstTrack",function(r,e){return u(e)}),e.$on("play",function(r,e){return o(e)}),e.$on("pause",function(r,e){return i(e)}),u=function(e){return null==r.cur_playing||r.cur_playing.id!==e.id?r.cur_playing=e:void 0}}]),angular.module("aimprApp").controller("TracksCtrl",["$scope","$rootScope","$interval","$routeParams","Info","TrackService","API","LyricsProcessor","Q","ViewHelpers","$timeout","initScroll","$window","Stat","Ladda",function(r,e,n,t,i,o,u,a,c,s,l,d,f,p,_){var m,g,v,h,y,k,w,$,T,A,b,S;console.info("TracksCtrl"),v=null,r.viewer_id=i.viewer_id,S=i.user_id,A=null,m=null,angular.extend(r,{per_page:25,cur_page:1,per_part:100,cur_part:1,is_loading:!0}),r.$watch(function(){return p.is_all_tracks},function(r,e){return r!==e?g(r):void 0}),g=function(e){return r.reload=!0,r.tracks=r.rendered_tracks=null,r.cur_part=r.cur_page=1,A=null,e?h(function(){return r.reload=!1}):y(function(){return r.reload=!1})},b=function(){var e,n,t;return t=r.per_page*(r.cur_page-1),e=t+r.per_page-1,n=r.tracks.slice(t,+e+1||9e9),r.rendered_tracks=(r.rendered_tracks||[]).concat(n),r.cur_page+=1},h=function(e){var n;return n={count:r.per_part,offset:r.per_part*(r.cur_part-1)},u.getTracks(S,n).then(function(n){return r.tracks=(r.tracks||[]).concat(n.items),m=n.count,b(),r.is_loading=!1,r.cur_part+=1,r.$apply(),s.resizeIFrame(),e?e():void 0})},y=function(e){var n;return n={count:r.per_part,offset:A||r.per_part*(r.cur_part-1)},u.getTracksWithoutLyrics(S,n).then(function(n){return A=n.magic_offset,r.tracks=(r.tracks||[]).concat(n.items),m=i.without_lyrics_count,b(),r.is_loading=!1,r.cur_part+=1,r.$apply(),s.resizeIFrame(),e?e():void 0})},p.is_all_tracks?h(function(){var e;return(null!=(e=r.tracks)?e.length:void 0)?(r.$emit("setFirstTrack",r.tracks[0]),s.resizeIFrame()):void 0}):y(function(){var e;return(null!=(e=r.tracks)?e.length:void 0)?(r.$emit("setFirstTrack",r.tracks[0]),s.resizeIFrame()):void 0}),e.$on("improveList",function(){var e,n;return e=p.is_all_tracks?"all_count":"without_lyrics_count",n=p[e].all,a.improveList(r.tracks,function(t){var i;return i=p[e].improved+p[e].failed,_.progress(i,n),Object.keys(t.lyrics).length?o.save(t,function(){return p[e].improved+=1,t.state="improved",r.$parent.$apply()}):(p[e].failed+=1,t.state="failed")},function(){return lada.stop()})}),T=function(){return r.is_loading=!0,b(),r.$apply(),l(function(){return r.is_loading=!1},500),s.resizeIFrame(),w()?p.is_all_tracks||!$()?h():y():void 0},$=function(){return r.viewer_id===S},w=function(){var e,n;return e=r.tracks.length,n=Math.floor(e/r.per_page),r.cur_page===n},k=function(){var e,n;return p.is_all_tracks||!$()?(null!=(e=r.rendered_tracks)?e.length:void 0)>=m:(null!=(n=r.rendered_tracks)?n.length:void 0)>=p.without_lyrics_count.all},d(function(e,n){var t;return t=f.innerHeight-(e+n)<500,!t||r.is_loading||k()?void 0:T()}),r.playOrPause=function(e){return r.tracks.map(function(r){return r.id!==e.id&&(r.is_playing=!1),r}),o.cur_playing&&o.cur_playing.id===e.id&&e.is_playing?(e.is_playing=!1,r.$emit("pause",e)):(e.is_playing=!0,r.$emit("play",e)),o.cur_playing=angular.copy(e)},r.addOrRemove=function(e,n){return null==n&&(n={}),null!=n.my_list?null!=e.deleted?e.deleted===!0?o.restore(e,function(){return r.$apply(function(){return e.deleted=null})}):o.add(e):o["delete"](e,function(){return r.$apply(function(){return e.deleted=!0})}):null!=e.deleted?e.deleted===!0?o.restore(e,function(){return r.$apply(function(){return e.deleted=!1})}):o["delete"](e,function(){return r.$apply(function(){return e.deleted=!0})}):o.add(e,function(n){return e.new_id=n,e.new_owner_id=r.viewer_id.toString(),r.$apply(function(){return e.deleted=!1})})},r.showTrack=function(e){return o.cur_track=r.tracks.filter(function(r){return r.id===e})[0],v===e?(s.resizeIFrame(),v=null):v=e},r.isTrackSelected=function(r){return v===r},e.$on("showUserTracks",function(e,n,t){return S!==n?(i.user_id=S=n,r.tracks=r.rendered_tracks=null,r.cur_part=r.cur_page=1,r.reload=!0,h(function(){return r.reload=!1,t?t():void 0})):void 0}),e.$on("getNextTrack",function(e,n){var t,i;return t=r.tracks.map(function(r){return r.id}).indexOf(n),i=t===r.tracks.length-1?0:t+1,r.playOrPause(r.tracks[i])})}]),angular.module("aimprApp").directive("lyricsTabs",["$rootScope","TrackService","ViewHelpers",function(r,e,n){return{templateUrl:"views/shared/tabs.html",restrict:"E",scope:{track:"="},link:function(){return $(".tab ul.tabs").addClass("active").find("> li:eq(0)").addClass("current"),$(".tab ul.tabs").on("click","li a",function(r){var e,n;return n=$(this).closest(".tab"),e=$(this).closest("li").index(),n.find("ul.tabs > li").removeClass("current"),$(this).closest("li").addClass("current"),n.find(".tab_content").find("div.tabs_item").not("div.tabs_item:eq("+e+")").slideUp(),n.find(".tab_content").find("div.tabs_item:eq("+e+")").slideDown(),r.preventDefault()})},controller:function(r,e,t){var i;return r.updateText=function(e){return r.track.lyrics[r.selected_site]=e},i=function(){return r.selected_site=r.track.best_lyrics_from,n.resizeIFrame()},i(),e.$on("setSelectedSite",i),r.save=function(e){return e.best_lyrics_from=r.selected_site,t.save(e,function(){return e.state="improved",r.$parent.$apply()})},r.select=function(e){return r.selected_site=e},r.isAnyText=function(){return Object.keys(r.track.lyrics).length>0}}}}]),angular.module("aimprApp").directive("postRender",function(){return{restrict:"A",link:function(r,e,n){return r.$emit(n.postRender)}}}),angular.module("aimprApp").directive("wtf",function(){return{restrict:"A",link:function(r,e){return localStorage.wtf_read?void 0:e.click()}}}),angular.module("aimprApp").filter("duration",function(){return function(r,e){var n,t,i;return n=Math.floor(r/3600),t=Math.floor((r-3600*n)/60),i=Math.floor(r-3600*n-60*t),e&&10>t&&(t="0"+t),10>i&&(i="0"+i),[n,""+t+":"+i].filter(function(r){return r}).join(":")}}),angular.module("aimprApp").filter("trackName",["$filter",function(r){return function(e,n,t){return null==n&&(n=42),null==t&&(t=!1),e?r("characters")(""+e.artist+" - "+e.title,n,t):void 0}}]),angular.module("aimprApp").factory("API",["$http","$timeout","VK","notify",function(r,e,n,t){var i,o,u,a,c;return o=!1,i=function(r){var e;return e=/localhost/.test(location.hostname)?"https://localhost:2053":"https://aimpr.milushov.ru:2053",""+e+"/search/"+r},u=function(r,e){var n,i;return null!=(i=r.response)?e.resolve(i):(n=r.error.error_msg||r.error,"object"==typeof r.error&&t({message:n,classes:"my-alert-danger"}),e.reject(new Error(n)))},c=function(r,n,i){var u;return u="server is died :( please try again later",o||(t({message:u,classes:"my-alert-danger"}),e(function(){return o=!1},1e4)),o=!0,i.reject(new Error(u))},a=function(r,e,n){var t;return t="server is died or thinking more than 3 seconds :( please try again later",n.reject(new Error(t))},{getTracks:function(r,e){var t;return null==e&&(e={}),t=Q.defer(),n.then(function(n){return n.api("audio.get",{count:e.count||100,offset:e.offset,owner_id:r},function(r){return u(r,t)})}),t.promise},getTracksWithoutLyrics:function(r,e){var t;return null==e&&(e={}),t=Q.defer(),n.then(function(n){return n.api("execute",{code:"var count = "+e.count+",\n    over_count = count*2,\n    offset = "+e.offset+',\n    i = 0,\n    magic_offset = null,\n    audio_ids = "";\n\nvar a = API.audio.get({\n  owner_id: '+r+',\n  offset: offset,\n  count: over_count\n}).items;\n\nvar x = 0;\n\nwhile (i <= a.length) {\n  if(!a[i].lyrics_id && !magic_offset) {\n    x = x + 1;\n    audio_ids = audio_ids + "," + a[i].id;\n  }\n\n  i = i + 1;\n  if(x == count) {\n    magic_offset = offset + i;\n    i = 100500;\n  }\n}\n\nvar audio_without_lyrics = null;\n\nif(audio_ids != ",") {\n  audio_without_lyrics = API.audio.get({\n    owner_id: '+r+",\n    audio_ids: audio_ids\n  }).items;\n} else {\n  audio_without_lyrics = [];\n}\n\nif(!magic_offset) magic_offset = offset + over_count;\n\nreturn {\n  items: audio_without_lyrics,\n  magic_offset: magic_offset\n};"},function(r){return u(r,t)})}),t.promise},searchTrack:function(r,e){var t,i;return null==e&&(e=0),i=null!=e?0:1,t=Q.defer(),n.then(function(n){return n.api("audio.search",{q:r,auto_complete:1,lyrics:i,sort:0,search_own:e,count:5},function(r){return u(r,t)})}),t.promise},searchTracksWithLyrics:function(r){var e,t;return e=Q.defer(),t=""+r.artist+" "+r.title,n.then(function(r){return r.api("execute",{code:'var lids = API.audio.search({\n  "q":"'+t+'",\n  "auto_complete": 1,\n  "lyrics": 1,\n  "sort": 2,\n  "count": 7\n}).items@.lyrics_id;\n\nvar texts = [], i = 0;\n\nwhile(i != lids.length) {\n  texts.push(API.audio.getLyrics({\n    "lyrics_id": lids[i]\n  }).text);\n  i = i + 1;\n}\n\nreturn {count: texts.length, items: texts, vk: true};'},function(r){return u(r,e)})}),e.promise},getAudioCountAndLyricsIds:function(r){var e;return e=Q.defer(),n.then(function(n){return n.api("execute",{code:'var a = API.audio.getCount({"owner_id": '+r+'});\nif (a > 6000) a = 6000;\nvar b = API.audio.get({"owner_id": '+r+"}).items@.lyrics_id;\nreturn { audio_count: a, without_lyrics: b };"},function(r){return u(r,e)})}),e.promise},getLyrics:function(r){var e;return e=Q.defer(),n.then(function(n){return n.api("audio.getLyrics",{lyrics_id:r},function(r){return u(r,e)})}),e.promise},saveTrack:function(r,e){var t;return t=Q.defer(),e.need_to_save?n.then(function(n){return n.api("audio.edit",{owner_id:r,audio_id:e.id,text:e.lyrics[e.best_lyrics_from]},function(r){return u(r,t)})}):u({response:e.id},t),t.promise},addTrack:function(r){var e;return e=Q.defer(),n.then(function(n){return n.api("audio.add",{audio_id:r.id,owner_id:r.owner_id},function(r){return u(r,e)})}),e.promise},deleteTrack:function(r){var e;return e=Q.defer(),n.then(function(n){return n.api("audio.delete",{audio_id:r.new_id||r.id,owner_id:r.new_owner_id||r.owner_id},function(r){return u(r,e)})}),e.promise},restoreTrack:function(r){var e;return e=Q.defer(),n.then(function(n){return n.api("audio.restore",{audio_id:r.new_id||r.id,owner_id:r.new_owner_id||r.owner_id},function(r){return u(r,e)})}),e.promise},getFriends:function(r,e){var t;return null==e&&(e={}),t=Q.defer(),n.then(function(n){return n.api("friends.get",{user_id:r,order:"name",fields:"nickname,domain,photo_50",count:e.count,offset:e.offset},function(r){return u(r,t)})}),t.promise},getLyricsFromApi:function(e){var n,t;return t=""+e.artist+" "+e.title,n=Q.defer(),r.get(i(t),{timeout:3e3}).success(function(r){return u(r,n)}).error(function(r,e){return a(r,e,n)}),n.promise}}}]),angular.module("aimprApp").factory("audio",["$document",function(r){var e;return e=r[0].createElement("audio"),{el:e,play:function(r){return r&&(e.src=r),e.play()},pause:function(){return e.pause()},setEndHandler:function(r){return e.onended=r}}}]),angular.module("aimprApp").service("ViewHelpers",["$document","VK","$timeout",function(r,e,n){this.resizeIFrame=function(){var t,i,o,u;return i=r[0].querySelector("body"),u=i.getBoundingClientRect(),o=15,t=200,n(function(){return e.then(function(r){return r.callMethod("resizeWindow",u.width,u.height+o)})},t)}}]),angular.module("aimprApp").service("Info",["$location",function(r){var e;return e=r.search(),this.viewer_id=parseInt(e.viewer_id),this.user_id=parseInt("0"===e.user_id?e.viewer_id:e.user_id)}]),angular.module("aimprApp").factory("Ladda",["$document","$rootScope",function(r,e){var n;return n=null,e.$on("ladda-init",function(){return n=Ladda.create(r[0].querySelector(".ladda-button"))}),{start:function(){return n.start()},stop:function(){return n.stop()},progress:function(r,e){var t;return t=Math.round(r/e*100)/100,n.setProgress(t)}}}]),angular.module("aimprApp").service("LyricsProcessor",["$interval","$rootScope","API","TrackService","notify",function(r,e,n,t,i){var o,u,a,c;o=2e3,u=function(r){var e,n,t;e=Object.keys(r)[0];for(n in r)t=r[n],t.length>r[e].length&&(e=n);return e},a=function(r){var e,n,t,i;for(e=r[0],t=0,i=r.length;i>t;t++)n=r[t],n.length>e.length&&(e=n);return e},this.improveList=function(r,e,n){return this.prepareList(r,e,n)},this.improveOne=function(r,e,n){return this.prepareList([r],e,n)},c=!1,this.prepareList=function(e,s){var l,d,f,p,_,m,g;return f=Object.keys(e),e.map(function(r){return r.lyrics={}}),c?i({message:"processing already started",classes:"my-alert-danger"}):(c=!0,m=function(r,e,n){var t;return e.lyrics=e.lyrics||{},r.count>0&&(t=r.vk?{vk:a(r.items)}:r.items,angular.extend(e.lyrics,t)),0===n?(e.is_loading=!1,c=!1,p(e),s(e)):void 0},d=function(r,e,n){return console.error(null!=r.message?r.message:void 0),0===n?(e.is_loading=!1,c=!1,p(e),s(e)):void 0},p=function(r){var e,n;return n=t.getChoiceFromLocalStorage(r),e=u(r.lyrics),r.best_lyrics_from=n||e},l=function(){return console.info("queue.length",f.length),0===f.length?(r.cancel(_),finish_callback()):void 0},g=function(r){var e;return e=2,n.getLyricsFromApi(r).then(function(n){return m(n,r,e-=1),l()},function(n){return d(n,r,e-=1),l()}),n.searchTracksWithLyrics(r).then(function(n){return m(n,r,e-=1),l()},function(n){return d(n,r,e-=1),l()})},g(e[f.shift()]),f.length?_=r(function(){var r;return r=e[f.shift()],r.is_loading=!0,g(r)},o):void 0)}}]),angular.module("aimprApp").service("Stat",function(){this.is_all_tracks=!1,this.all_count={all:0,improved:0,failed:0},this.without_lyrics_count={all:0,improved:0,failed:0}}),angular.module("aimprApp").service("TrackService",["$localStorage","API","Info",function(r,e,n){null==r.sites&&(r.sites=[]),null==r.tracks&&(r.tracks={}),this.save=function(r){return function(t,i){return t.need_to_save=!1,e.saveTrack(n.viewer_id,t).then(function(){return r.saveChoiceToLocalStorage(t),i?i():void 0})}}(this),this.saveChoiceToLocalStorage=function(e){var n,t;return t=e.best_lyrics_from,~(n=r.sites.indexOf(t))||(n=r.sites.push(t)-1),r.tracks[e.id]=n+1},this.getChoiceFromLocalStorage=function(e){var n;return(n=r.tracks[e.id])?r.sites[n-1]:void 0},this.add=function(r,n){return e.addTrack(r).then(function(r){return console.info("added"),n(r)})},this["delete"]=function(r,n){return e.deleteTrack(r).then(function(r){return console.info("deleted"),n(r)})},this.restore=function(r,n){return e.restoreTrack(r).then(function(r){return console.info("restored"),n(r)})}}]),angular.module("aimprApp").value("Q",Q).factory("VK",["Q",function(r){var e;return e=r.defer(),VK.init(function(){return e.resolve(VK)},function(){return console.error("error with VK init")},"5.27"),e.promise}]).factory("initScroll",["VK",function(r){return function(e){return r.then(function(r){return r.callMethod("scrollSubscribe",!0),r.addCallback("onScroll",function(r,n){return e(r,n)})})}}]),$(function(){var r={$window:$(window),$html:$("html"),$body:$("body"),$container:$(".aimpr"),init:function(){$(function(){r.modals.init()})},modals:{trigger:$(".yo-modal-trigger"),trigger_class:".yo-modal-trigger",modal:$(".yo-modal"),scrollTopPosition:null,init:function(){var e=this;r.$body.append('<div class="yo-modal-overlay"></div>'),e.triggers()},triggers:function(){var e=this;r.$body.on("click",e.trigger_class,function(r){r.preventDefault();var n=$(this);e.openModal(n,n.data("modalId"))}),$(".yo-modal-overlay").on("click",function(r){r.preventDefault(),e.closeModal()}),r.$body.on("keydown",function(r){27===r.keyCode&&e.closeModal()}),$(".yo-modal-close").on("click",function(r){r.preventDefault(),e.closeModal(),localStorage.wtf_read=!0})},openModal:function(e,n){var t=this,i=r.$window.scrollTop(),o=$("#"+n);t.scrollTopPosition=i,r.$html.addClass("yo-modal-show").attr("data-modal-effect",o.data("modal-effect")),o.addClass("yo-modal-show"),r.$container.scrollTop(i)},closeModal:function(){var e=this;$(".yo-modal-show").removeClass("yo-modal-show"),r.$html.removeClass("yo-modal-show").removeAttr("data-modal-effect"),r.$window.scrollTop(e.scrollTopPosition)}}};r.init()});